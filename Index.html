<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Quản lý lớp học theo Ca</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <style>
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #startStatus {
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: bold;
    }
    .stat-box {
      padding: 15px;
      border-radius: 8px;
      color: white;
      text-align: center;
    }
  </style>
</head>

<body class="container mt-4">

  <div id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;"></div>
  </div>

  <h2 class="mb-4 text-center">Quản lý lớp học theo Ca</h2>

  <!-- CHỌN LỚP -->
  <div class="mb-3">
    <label class="form-label fw-bold">Chọn lớp:</label>
    <select id="classSelect" class="form-select"></select>
  </div>

  <!-- CHỌN CA -->
  <div class="mb-3">
    <label class="form-label fw-bold">Chọn ca học:</label>
    <select id="caSelect" class="form-select">
      <option value="Ca1">Ca 1</option>
      <option value="Ca2">Ca 2</option>
      <option value="Ca3">Ca 3</option>
      <option value="Ca4">Ca 4</option>
      <option value="Ca5">Ca 5</option>
    </select>
  </div>

  <!-- START STATUS -->
  <div id="startStatus"></div>

  <!-- MODE HIỆN TẠI -->
  <div class="mt-3">
    <label class="fw-bold">Chế độ hiện tại:</label>
    <div id="currentMode" class="fs-5 text-primary"></div>
  </div>

  <!-- BUTTONS -->
  <div class="mt-4" id="buttonsArea"></div>

  <!-- DASHBOARD -->
  <h4 class="mt-4">Dashboard thống kê</h4>

  <div class="row mt-3">
    <div class="col-md-3">
      <div class="stat-box bg-primary">
        <h4 id="statTotal">0</h4><p>Tổng sinh viên</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-box bg-success">
        <h4 id="statIn">0</h4><p>Đã Check-In</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-box bg-danger">
        <h4 id="statLeftIn">0</h4><p>Chưa Check-In</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-box bg-warning">
        <h4 id="statLeftOut">0</h4><p>Chưa Check-Out</p>
      </div>
    </div>
  </div>

  <!-- DANH SÁCH ĐIỂM DANH -->
  <h4 class="mt-4">Danh sách điểm danh realtime</h4>

  <table class="table table-bordered mt-2">
    <thead class="table-dark">
      <tr>
        <th>StudentID</th>
        <th>Name</th>
        <th>Check-In</th>
        <th>Check-Out</th>
      </tr>
    </thead>
    <tbody id="attendanceBody"></tbody>
  </table>

<script>
const ROOT = "https://script.google.com/macros/s/AKfycbzYAAH_6jHNbeXII324G0ROwiS3tNiNb27kR3AZqNpZHc88VE4lKQ8af6796tjFLMyS/exec";

let refreshPaused = false;
let currentClass = "";
let currentCa    = "";

/* LOADING */
function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

/* RESET UI */
function resetUI() {
  document.getElementById("attendanceBody").innerHTML = "";
  document.getElementById("statTotal").innerText = "0";
  document.getElementById("statIn").innerText = "0";
  document.getElementById("statLeftIn").innerText = "0";
  document.getElementById("statLeftOut").innerText = "0";
  document.getElementById("currentMode").innerHTML = "";
  document.getElementById("startStatus").innerHTML = "";
  document.getElementById("buttonsArea").innerHTML = "";
}

/* LOAD CLASS LIST */
function loadClasses() {
  fetch(ROOT + "?action=getClasses&nocache=" + Date.now())
    .then(r => r.json())
    .then(data => {
      let sel = document.getElementById("classSelect");
      sel.innerHTML = "";
      data.forEach(c => sel.innerHTML += `<option value="${c.ClassID}">${c.ClassName}</option>`);

      currentClass = sel.value;
      refreshModeAndStart();
      loadStats();
      loadAttendance();
    });
}

/* REFRESH MODE + START */
function refreshModeAndStart() {
  if (refreshPaused) return;

  fetch(ROOT + "?action=getClasses&nocache=" + Date.now())
    .then(r => r.json())
    .then(list => {
      let obj = list.find(x => x.ClassID === currentClass);
      if (!obj) return;

      document.getElementById("currentMode").innerText = obj.Mode;

      let s = document.getElementById("startStatus");
      s.innerText = obj.Start ? "Trạng thái: ĐANG HOẠT ĐỘNG" : "Trạng thái: ĐÃ TẮT";
      s.style.color = obj.Start ? "#28a745" : "#d9534f";

      renderButtons(obj);
    });
}

/* RENDER BUTTONS */
function renderButtons(obj) {
  let btn = document.getElementById("buttonsArea");
  btn.innerHTML = "";

  if (!obj.Start)
    btn.innerHTML += `<button class="btn btn-warning me-2" onclick="startClass()">Bắt đầu</button>`;
  else
    btn.innerHTML += `<button class="btn btn-danger me-2" onclick="stopClass()">Dừng</button>`;

  if (obj.Mode === "Register") return;

  if (obj.Mode === "Attendance") {
    btn.innerHTML += `<button class="btn btn-danger" onclick="changeMode('Checkout')">Chuyển sang Check-out</button>`;
    return;
  }

  if (obj.Mode === "Checkout") {
    btn.innerHTML += `<button class="btn btn-success" onclick="changeMode('Attendance')">Chuyển sang Điểm danh</button>`;
    return;
  }
}

/* START CLASS */
function startClass() {
  showLoading();
  fetch(`${ROOT}?action=start&class=${currentClass}&ca=${currentCa}`)
    .then(() => loadClasses())
    .finally(() => hideLoading());
}

/* STOP CLASS */
function stopClass() {
  showLoading();
  fetch(`${ROOT}?action=stop&class=${currentClass}`)
    .then(() => loadClasses())
    .finally(() => hideLoading());
}

/* CHANGE MODE */
function changeMode(mode) {
  showLoading();
  fetch(`${ROOT}?action=changeMode&class=${currentClass}&mode=${mode}`)
    .then(() => loadClasses())
    .finally(() => hideLoading());
}

/* DASHBOARD */
function loadStats() {
  if (refreshPaused) return;

  fetch(`${ROOT}?action=checkUpdate&class=${currentClass}&ca=${currentCa}`)
    .then(r => r.json())
    .then(s => {
      document.getElementById("statTotal").innerText = s.total;
      document.getElementById("statIn").innerText = s.checkedIn;
      document.getElementById("statLeftIn").innerText = s.leftToCheckIn;
      document.getElementById("statLeftOut").innerText = s.leftToCheckOut;
    });
}

/* FORMAT TIME */
function formatTime(t) {
  if (!t) return "";
  return new Date(t).toLocaleString("vi-VN");
}

/* LOAD ATTENDANCE */
function loadAttendance() {
  if (refreshPaused) return;

  fetch(`${ROOT}?action=getAttendance&class=${currentClass}&ca=${currentCa}`)
    .then(r => r.json())
    .then(list => {
      let b = document.getElementById("attendanceBody");
      b.innerHTML = "";
      list.forEach(x => {
        b.innerHTML += `
          <tr>
            <td>${x.StudentID}</td>
            <td>${x.Name}</td>
            <td>${formatTime(x.CheckIn)}</td>
            <td>${formatTime(x.CheckOut)}</td>
          </tr>`;
      });
    });
}

/* AUTO REFRESH */
setInterval(() => {
  refreshModeAndStart();
  loadStats();
  loadAttendance();
}, 900);

/* KHI ĐỔI LỚP HOẶC CA */
function onClassOrCaChanged() {
  refreshPaused = true;
  resetUI();

  currentClass = document.getElementById("classSelect").value;
  currentCa    = document.getElementById("caSelect").value;

  setTimeout(() => {
    refreshPaused = false;
    refreshModeAndStart();
    loadStats();
    loadAttendance();
  }, 500);
}

document.getElementById("classSelect").addEventListener("change", onClassOrCaChanged);
document.getElementById("caSelect").addEventListener("change", onClassOrCaChanged);

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  currentCa = document.getElementById("caSelect").value;
  loadClasses();
});
</script>

</body>
</html>
