<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Quản lý lớp học theo Ca</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

  <style>
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #startStatus {
      margin-top: 10px;
      font-size: 1.1rem;
      font-weight: bold;
    }
    .stat-box {
      padding: 15px;
      border-radius: 8px;
      color: white;
      text-align: center;
    }
  </style>
</head>

<body class="container mt-4">

  <!-- LOADING -->
  <div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
  </div>

  <h2 class="mb-4 text-center">Quản lý lớp học theo Ca</h2>

  <!-- CHỌN LỚP -->
  <div class="mb-3">
    <label class="form-label fw-bold">Chọn lớp:</label>
    <select id="classSelect" class="form-select"></select>
  </div>

  <!-- CHỌN CA -->
  <div class="mb-3">
    <label class="form-label fw-bold">Chọn ca học:</label>
    <select id="caSelect" class="form-select">
      <option value="Ca1">Ca 1</option>
      <option value="Ca2">Ca 2</option>
      <option value="Ca3">Ca 3</option>
      <option value="Ca4">Ca 4</option>
      <option value="Ca5">Ca 5</option>
    </select>
  </div>

  <!-- TRẠNG THÁI START -->
  <div id="startStatus"></div>

  <!-- MODE HIỆN TẠI -->
  <div class="mb-3 mt-3">
    <label class="fw-bold">Chế độ hiện tại:</label>
    <div id="currentMode" class="fs-5 text-primary"></div>
  </div>

  <!-- BUTTONS -->
  <div class="mt-4" id="buttonsArea"></div>

  <!-- DASHBOARD -->
  <h4 class="mt-4">Dashboard thống kê</h4>

  <div class="row mt-3">
    <div class="col-md-3">
      <div class="stat-box bg-primary">
        <h4 id="statTotal">0</h4>
        <p>Tổng sinh viên</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-box bg-success">
        <h4 id="statIn">0</h4>
        <p>Đã Check-In</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-box bg-danger">
        <h4 id="statLeftIn">0</h4>
        <p>Chưa Check-In</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-box bg-warning">
        <h4 id="statLeftOut">0</h4>
        <p>Chưa Check-Out</p>
      </div>
    </div>
  </div>

  <!-- DANH SÁCH ĐIỂM DANH -->
  <h4 class="mt-4">Danh sách điểm danh realtime</h4>
  <table class="table table-bordered mt-2">
    <thead class="table-dark">
      <tr>
        <th>StudentID</th>
        <th>Name</th>
        <th>Check-In</th>
        <th>Check-Out</th>
      </tr>
    </thead>
    <tbody id="attendanceBody"></tbody>
  </table>

<script>
const ROOT = "https://script.google.com/macros/s/AKfycbyxb7WrXFDOlkKjSChvhm1kBq-yiGBzezWE4wFqAKX2RPMkj7rdzQkyWCoc8enOdY8fng/exec";

let sessionID = 0;      
let currentClass = "";
let currentCa = "";

/* SHOW/HIDE LOADING */
function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

/* RESET UI */
function resetUI() {
  document.getElementById("attendanceBody").innerHTML = "";
  document.getElementById("statTotal").innerText = "0";
  document.getElementById("statIn").innerText = "0";
  document.getElementById("statLeftIn").innerText = "0";
  document.getElementById("statLeftOut").innerText = "0";
  document.getElementById("currentMode").innerHTML = "";
  document.getElementById("startStatus").innerHTML = "";
  document.getElementById("buttonsArea").innerHTML = "";
}

/* LOAD CLASS LIST */
function loadClasses() {
  fetch(ROOT + "?action=getClasses&nocache=" + Date.now())
    .then(r => r.json())
    .then(data => {
      let select = document.getElementById("classSelect");
      select.innerHTML = "";
      data.forEach(c => {
        select.innerHTML += `<option value="${c.ClassID}">${c.ClassName}</option>`;
      });

      if (!currentClass) currentClass = select.value;

      refreshAll();
    });
}

/* LOAD FULL UI */
function refreshAll() {
  let thisSession = sessionID;  // gắn ID

  let classID = currentClass;
  let ca = currentCa;

  // Nếu request về nhưng sessionID thay đổi → bỏ qua
  fetch(ROOT + "?action=getClasses&nocache=" + Date.now())
    .then(r => r.json())
    .then(list => {
      if (thisSession !== sessionID) return;

      let obj = list.find(c => c.ClassID === classID);
      if (!obj) return;

      document.getElementById("currentMode").innerText = obj.Mode;

      let st = document.getElementById("startStatus");
      st.innerText = obj.Start ? "Trạng thái: ĐANG HOẠT ĐỘNG" : "Trạng thái: ĐÃ TẮT";
      st.style.color = obj.Start ? "#28a745" : "#d9534f";

      renderButtons(obj);
    });

  fetch(`${ROOT}?action=checkUpdate&class=${classID}&ca=${ca}`)
    .then(r => r.json())
    .then(st => {
      if (thisSession !== sessionID) return;

      document.getElementById("statTotal").innerText = st.total;
      document.getElementById("statIn").innerText = st.checkedIn;
      document.getElementById("statLeftIn").innerText = st.leftToCheckIn;
      document.getElementById("statLeftOut").innerText = st.leftToCheckOut;
    });

  fetch(`${ROOT}?action=getAttendance&class=${classID}&ca=${ca}`)
    .then(r => r.json())
    .then(list => {
      if (thisSession !== sessionID) return;

      let body = document.getElementById("attendanceBody");
      body.innerHTML = "";

      list.forEach(r => {
        body.innerHTML += `
          <tr>
            <td>${r.StudentID}</td>
            <td>${r.Name}</td>
            <td>${formatTime(r.CheckIn)}</td>
            <td>${formatTime(r.CheckOut)}</td>
          </tr>`;
      });
    });
}

/* FORMAT TIME */
function formatTime(t) {
  if (!t) return "";
  return new Date(t).toLocaleString("vi-VN");
}

/* BUTTON RENDER */
function renderButtons(obj) {
  let btn = document.getElementById("buttonsArea");
  btn.innerHTML = "";

  if (!obj.Start) {
    btn.innerHTML += `<button class="btn btn-warning me-2" onclick="startClass()">Bắt đầu</button>`;
  } else {
    btn.innerHTML += `<button class="btn btn-danger me-2" onclick="stopClass()">Dừng</button>`;
  }

  if (obj.Mode === "Register") return;

  if (obj.Mode === "Attendance") {
    btn.innerHTML += `<button class="btn btn-danger" onclick="changeMode('Checkout')">Chuyển sang Check-out</button>`;
    return;
  }

  if (obj.Mode === "Checkout") {
    btn.innerHTML += `<button class="btn btn-success" onclick="changeMode('Attendance')">Chuyển sang Điểm danh</button>`;
    return;
  }
}

/* START */
function startClass() {
  let classID = currentClass;
  let ca = currentCa;

  showLoading();
  fetch(`${ROOT}?action=start&class=${classID}&ca=${ca}`)
    .then(() => refreshAll())
    .finally(hideLoading);
}

/* STOP */
function stopClass() {
  let classID = currentClass;

  showLoading();
  fetch(`${ROOT}?action=stop&class=${classID}`)
    .then(() => refreshAll())
    .finally(hideLoading);
}

/* CHANGE MODE */
function changeMode(mode) {
  let classID = currentClass;

  showLoading();
  fetch(`${ROOT}?action=changeMode&class=${classID}&mode=${mode}`)
    .then(() => refreshAll())
    .finally(hideLoading);
}

/* AUTO LOOP */
setInterval(() => {
  refreshAll();
}, 1000);

/* ĐỔI LỚP */
document.getElementById("classSelect").addEventListener("change", (e) => {
  currentClass = e.target.value;
  sessionID++;     // Tăng session
  resetUI();
  refreshAll();
});

/* ĐỔI CA */
document.getElementById("caSelect").addEventListener("change", (e) => {
  currentCa = e.target.value;
  sessionID++;
  resetUI();
  refreshAll();
});

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  currentCa = document.getElementById("caSelect").value;
  loadClasses();
});
</script>

</body>
</html>
